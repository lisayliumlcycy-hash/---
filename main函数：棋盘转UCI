import cv2
import time
import chess
import ipywidgets as widgets
from IPython.display import display, clear_output
from collections import namedtuple

# å¯¼å…¥ä½ çš„è‡ªå®šä¹‰æ¨¡å—
from vision import get_position_from_image, SquareType, ChessboardNotFoundError, width, height

# --- 1. é€‚é…å™¨ä¸å·¥å…·å‡½æ•° ---
Square = namedtuple("Square", ["x", "y"])

def get_internal_position(board):
    """å°†é€»è¾‘æ£‹ç›˜è½¬ä¸ºè§†è§‰çŸ©é˜µ"""
    res = []
    for x in range(8):
        row = []
        for y in range(8):
            rank_idx = x  # x=0 ä¸º Rank 1
            file_idx = 7 - y # y=7 ä¸º File a (0)
            piece = board.piece_at(chess.square(file_idx, rank_idx))
            if piece is None: row.append(SquareType.empty)
            elif piece.color == chess.WHITE: row.append(SquareType.white)
            else: row.append(SquareType.black)
        res.append(tuple(row))
    return tuple(res)

def matrix_to_uci(square):
    """è§†è§‰åæ ‡è½¬ UCI å­—ç¬¦ä¸²"""
    files = "hgfedcba" # y=0æ˜¯h, y=7æ˜¯a
    ranks = "12345678" # x=0æ˜¯1, x=7æ˜¯8
    return files[square.y] + ranks[square.x]

def print_debug_board(position):
    """ç¾åŒ–æ‰“å° 8x8 è¯†åˆ«çŸ©é˜µ"""
    print("   " + " ".join(["h","g","f","e","d","c","b","a"])) # åˆ—æ ‡
    for x in reversed(range(8)): # ä¸ºäº†è§†è§‰ä¸Šè®©ç¬¬8è¡Œåœ¨ä¸Šé¢
        row_str = f"{x+1} |"
        for y in range(8):
            row_str += f" {str(position[x][y])}"
        print(row_str + f" | {x+1}")
    print("   " + " ".join(["h","g","f","e","d","c","b","a"]))

# --- 2. ä¸»å¾ªç¯ ---

def main():
    # A. å¸ƒå±€ç»„ä»¶
    video_widget = widgets.Image(format='jpeg', width=width, height=height)
    debug_output = widgets.Output(layout={'border': '1px solid gray', 'height': '250px', 'overflow_y': 'scroll'})
    status_label = widgets.Label(value="ğŸŸ¢ ç³»ç»Ÿå¯åŠ¨ä¸­...")
    
    display(widgets.VBox([
        status_label,
        widgets.HBox([video_widget, debug_output])
    ]))

    # B. åˆå§‹åŒ–
    cap = cv2.VideoCapture(0)
    board = chess.Board()
    current_logic_pos = get_internal_position(board)
    
    last_seen_pos = None
    stable_count = 0
    STABLE_THRESHOLD = 8
    frame_counter = 0

    with debug_output:
        print("ğŸš€ åˆå§‹åŒæ­¥å®Œæˆã€‚è¯·å¼€å§‹èµ°å­...")

    try:
        while True:
            ret, frame = cap.read()
            if not ret: break
            frame_counter += 1

            # å®æ—¶æ›´æ–°ç”»é¢
            _, buffer = cv2.imencode('.jpg', frame)
            video_widget.value = buffer.tobytes()

            try:
                # 1. è§†è§‰è¯†åˆ«
                vision_pos, _ = get_position_from_image(frame)
                vision_pos = tuple(tuple(r) for r in vision_pos)

                # 2. å®šæ—¶æ‰“å°è¯†åˆ«å‡ºçš„æ£‹ç›˜ (æ¯30å¸§)
                if frame_counter % 30 == 0:
                    with debug_output:
                        clear_output(wait=True)
                        print(f"--- å¸§: {frame_counter} å®æ—¶è¯†åˆ«çŸ©é˜µ ---")
                        print_debug_board(vision_pos)
                        print(f"å½“å‰è½®åˆ°: {'ç™½' if board.turn else 'é»‘'} æ–¹")

                # 3. èµ°å­æ£€æµ‹é€»è¾‘
                if vision_pos != current_logic_pos:
                    if vision_pos == last_seen_pos:
                        stable_count += 1
                        status_label.value = f"â³ æ£€æµ‹åˆ°å˜åŒ–ï¼Œç§»å¼€æ‰‹... ({stable_count})"
                    else:
                        stable_count = 0
                        last_seen_pos = vision_pos
                    
                    if stable_count >= STABLE_THRESHOLD:
                        diffs = [Square(x, y) for x in range(8) for y in range(8) 
                                 if current_logic_pos[x][y] != vision_pos[x][y]]
                        
                        with debug_output:
                            print(f"\nğŸ”” æ£€æµ‹åˆ°ç¨³å®šå˜åŠ¨ï¼å˜åŠ¨æ ¼æ•°: {len(diffs)}")
                        
                        if len(diffs) == 2:
                            # ç¡®å®šèµ·ç‚¹ï¼šè§†è§‰ä¸Šå˜ä¸ºç©ºæ ¼çš„æ ¼å­
                            starts = [p for p in diffs if vision_pos[p.x][p.y] == SquareType.empty]
                            if len(starts) == 1:
                                start = starts[0]
                                end = [p for p in diffs if p != start][0]
                                move_uci = matrix_to_uci(start) + matrix_to_uci(end)
                                
                                try:
                                    move = chess.Move.from_uci(move_uci)
                                    if move in board.legal_moves:
                                        print(f"ğŸ¯ æˆåŠŸè¯†åˆ«èµ°å­: {move_uci}")
                                        board.push(move)
                                        current_logic_pos = get_internal_position(board)
                                        status_label.value = f"âœ… èµ°å­æˆåŠŸ: {move_uci}"
                                    else:
                                        with debug_output: print(f"âŒ éæ³•åŠ¨ä½œ: {move_uci}")
                                        status_label.value = f"âš ï¸ éæ³•åŠ¨ä½œ: {move_uci}"
                                except:
                                    pass
                        stable_count = 0
                else:
                    stable_count = 0
            
            except ChessboardNotFoundError:
                status_label.value = "ğŸ” å¯»æ‰¾æ£‹ç›˜ä¸­..."
            
            time.sleep(0.01)

    except KeyboardInterrupt:
        pass
    finally:
        cap.release()

if __name__ == "__main__":
    main()
