import time
from pydobot import Dobot

class SuctionArm:
    """
    Dobot Magician æœºæ¢°è‡‚å¸ç›˜æ§åˆ¶ç±»
    ä¸“é—¨ç”¨äºæ§åˆ¶å¸ç›˜è¿›è¡Œæ‹¾å–å’Œæ”¾ç½®æ“ä½œ
    """
    
    def __init__(self, port='/dev/ttyUSB0', verbose=True):
        """
        åˆå§‹åŒ–æœºæ¢°è‡‚è¿æ¥
        
        Args:
            port: ä¸²å£è®¾å¤‡è·¯å¾„
            verbose: æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ“ä½œä¿¡æ¯
        """
        self.port = port
        self.verbose = verbose
        self.dobot = None
        self.is_connected = False
        
        # å¸ç›˜å‚æ•°
        self.suction_enabled = False
        self.suction_duration = 1.0  # å¸ç›˜åŠ¨ä½œæŒç»­æ—¶é—´(ç§’)
        
        # å®‰å…¨è¿åŠ¨å‚æ•°
        self.lift_height = 50        # æŠ¬èµ·é«˜åº¦(mm)
        self.approach_speed = 50     # æ¥è¿‘é€Ÿåº¦
        self.pick_height = 5         # æ‹¾å–é«˜åº¦(è·ç¦»ç‰©ä½“è¡¨é¢)
        
        # é¢„è®¾ä½ç½®
        self.home_position = (200, 0, 100, 0)
        self.pickup_zone = (250, 0, 0, 0)    # æ‹¾å–åŒºåŸŸ
        self.placement_zone = (150, 150, 0, 0)  # æ”¾ç½®åŒºåŸŸ
        
        self.connect()
    
    def connect(self):
        """è¿æ¥æœºæ¢°è‡‚"""
        print(f"ğŸ”Œ è¿æ¥ Dobot Magician ({self.port})...")
        try:
            self.dobot = Dobot(port=self.port, verbose=False)
            
            # è·å–å½“å‰ä½ç½®
            current_pose = self.dobot.pose()
            print(f"ğŸ“ å½“å‰ä½ç½®: X={current_pose[0]:.2f}, Y={current_pose[1]:.2f}, Z={current_pose[2]:.2f}")
            
            # è®¾ç½®é€Ÿåº¦
            if hasattr(self.dobot, 'speed'):
                self.dobot.speed(100, 100)
            
            self.is_connected = True
            print("âœ… è¿æ¥æˆåŠŸï¼")
            
        except Exception as e:
            print(f"âŒ è¿æ¥å¤±è´¥: {e}")
            self.is_connected = False
    
    def set_suction(self, enable):
        """
        æ§åˆ¶å¸ç›˜å¼€å…³
        
        Args:
            enable: Trueå¼€å¯å¸ç›˜ï¼ŒFalseå…³é—­å¸ç›˜
        """
        if not self.is_connected:
            print("âŒ æœºæ¢°è‡‚æœªè¿æ¥")
            return False
        
        try:
            self.dobot.suck(enable)
            self.suction_enabled = enable
            
            action = "å¼€å¯" if enable else "å…³é—­"
            status = "ğŸ”´ å¸ç›˜å·¥ä½œä¸­" if enable else "âšª å¸ç›˜å…³é—­"
            
            if self.verbose:
                print(f"ğŸ”„ {status} - {action}å¸ç›˜")
            
            # ç­‰å¾…å¸ç›˜ç¨³å®š
            time.sleep(self.suction_duration)
            return True
            
        except Exception as e:
            print(f"âŒ å¸ç›˜æ§åˆ¶å¤±è´¥: {e}")
            return False
    
    def move_to_safe(self, x, y, z, r=0, wait=True):
        """
        å®‰å…¨ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ï¼ˆå…ˆæŠ¬èµ·åˆ°å®‰å…¨é«˜åº¦ï¼‰
        
        Args:
            x, y, z, r: ç›®æ ‡åæ ‡
            wait: æ˜¯å¦ç­‰å¾…ç§»åŠ¨å®Œæˆ
        """
        if not self.is_connected:
            return False
        
        # è·å–å½“å‰ä½ç½®
        current_pose = self.dobot.pose()
        current_z = current_pose[2]
        
        # å¦‚æœå½“å‰ä½ç½®è¾ƒä½ï¼Œå…ˆæŠ¬èµ·åˆ°å®‰å…¨é«˜åº¦
        if current_z < self.lift_height:
            self.dobot.move_to(current_pose[0], current_pose[1], self.lift_height, current_pose[3], wait=True)
            time.sleep(0.5)
        
        # ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®çš„å®‰å…¨é«˜åº¦
        self.dobot.move_to(x, y, self.lift_height, r, wait=True)
        time.sleep(0.5)
        
        # ä¸‹é™åˆ°ç›®æ ‡é«˜åº¦
        self.dobot.move_to(x, y, z, r, wait=wait)
        if wait:
            time.sleep(0.5)
        
        if self.verbose:
            print(f"âœˆï¸  ç§»åŠ¨åˆ°: X={x}, Y={y}, Z={z}")
        
        return True
    
    def pick_object(self, x, y, z=0, object_height=10):
        """
        æ‹¾å–ç‰©ä½“
        
        Args:
            x, y: ç‰©ä½“ä½ç½®åæ ‡
            z: ç‰©ä½“è¡¨é¢é«˜åº¦
            object_height: ç‰©ä½“é«˜åº¦(mm)
        """
        if not self.is_connected:
            return False
        
        print(f"ğŸ¯ å¼€å§‹æ‹¾å–ç‰©ä½“: ({x}, {y}, {z})")
        
        try:
            # æ­¥éª¤1: ç§»åŠ¨åˆ°ç‰©ä½“ä¸Šæ–¹å®‰å…¨ä½ç½®
            self.move_to_safe(x, y, z + self.lift_height)
            
            # æ­¥éª¤2: ä¸‹é™åˆ°æ‹¾å–é«˜åº¦
            pickup_z = z + self.pick_height
            self.dobot.move_to(x, y, pickup_z, 0, wait=True)
            time.sleep(0.5)
            
            if self.verbose:
                print(f"â¬‡ï¸  ä¸‹é™åˆ°æ‹¾å–é«˜åº¦: Z={pickup_z}")
            
            # æ­¥éª¤3: å¼€å¯å¸ç›˜
            if not self.set_suction(True):
                return False
            
            # æ­¥éª¤4: çŸ­æš‚ç­‰å¾…ç¡®ä¿å¸ç‰¢
            time.sleep(0.5)
            
            # æ­¥éª¤5: æŠ¬èµ·ç‰©ä½“åˆ°å®‰å…¨é«˜åº¦
            lift_z = z + object_height + self.lift_height
            self.dobot.move_to(x, y, lift_z, 0, wait=True)
            
            if self.verbose:
                print(f"â¬†ï¸  æŠ¬èµ·ç‰©ä½“åˆ°å®‰å…¨é«˜åº¦: Z={lift_z}")
            
            print("âœ… æ‹¾å–å®Œæˆï¼")
            return True
            
        except Exception as e:
            print(f"âŒ æ‹¾å–å¤±è´¥: {e}")
            # ç¡®ä¿å¸ç›˜å…³é—­
            self.set_suction(False)
            return False
    
    def place_object(self, x, y, z=0, object_height=10):
        """
        æ”¾ç½®ç‰©ä½“
        
        Args:
            x, y: æ”¾ç½®ä½ç½®åæ ‡
            z: æ”¾ç½®è¡¨é¢é«˜åº¦
            object_height: ç‰©ä½“é«˜åº¦(mm)
        """
        if not self.is_connected:
            return False
        
        print(f"ğŸ¯ å¼€å§‹æ”¾ç½®ç‰©ä½“: ({x}, {y}, {z})")
        
        try:
            # æ­¥éª¤1: ç§»åŠ¨åˆ°æ”¾ç½®ä½ç½®ä¸Šæ–¹
            self.move_to_safe(x, y, z + object_height + self.lift_height)
            
            # æ­¥éª¤2: ä¸‹é™åˆ°æ”¾ç½®é«˜åº¦
            place_z = z + self.pick_height
            self.dobot.move_to(x, y, place_z, 0, wait=True)
            time.sleep(0.5)
            
            if self.verbose:
                print(f"â¬‡ï¸  ä¸‹é™åˆ°æ”¾ç½®é«˜åº¦: Z={place_z}")
            
            # æ­¥éª¤3: å…³é—­å¸ç›˜
            if not self.set_suction(False):
                return False
            
            # æ­¥éª¤4: ç­‰å¾…ç‰©ä½“ç¨³å®šæ”¾ç½®
            time.sleep(0.5)
            
            # æ­¥éª¤5: æŠ¬èµ·åˆ°å®‰å…¨é«˜åº¦
            self.dobot.move_to(x, y, z + self.lift_height, 0, wait=True)
            
            if self.verbose:
                print("â¬†ï¸  æŠ¬èµ·åˆ°å®‰å…¨é«˜åº¦")
            
            print("âœ… æ”¾ç½®å®Œæˆï¼")
            return True
            
        except Exception as e:
            print(f"âŒ æ”¾ç½®å¤±è´¥: {e}")
            return False
    
    def pick_and_place(self, pick_x, pick_y, place_x, place_y, 
                      pick_z=0, place_z=0, object_height=10):
        """
        å®Œæ•´çš„æ‹¾å–å’Œæ”¾ç½®æ“ä½œ
        
        Args:
            pick_x, pick_y: æ‹¾å–ä½ç½®
            place_x, place_y: æ”¾ç½®ä½ç½®
            pick_z, place_z: é«˜åº¦åæ ‡
            object_height: ç‰©ä½“é«˜åº¦
        """
        print(f"\nğŸ”„ å¼€å§‹æ‹¾å–æ”¾ç½®æ“ä½œ:")
        print(f"   æ‹¾å–ä½ç½®: ({pick_x}, {pick_y}, {pick_z})")
        print(f"   æ”¾ç½®ä½ç½®: ({place_x}, {place_y}, {place_z})")
        
        # æ‹¾å–ç‰©ä½“
        if self.pick_object(pick_x, pick_y, pick_z, object_height):
            # æ”¾ç½®ç‰©ä½“
            if self.place_object(place_x, place_y, place_z, object_height):
                print("ğŸ‰ æ‹¾å–æ”¾ç½®æ“ä½œæˆåŠŸå®Œæˆï¼")
                return True
            else:
                print("âŒ æ”¾ç½®å¤±è´¥ï¼Œç‰©ä½“ä»åœ¨å¸ç›˜ä¸Š")
                # ç´§æ€¥æƒ…å†µï¼šå›åˆ°å®‰å…¨ä½ç½®å¹¶é‡Šæ”¾ç‰©ä½“
                self.move_to_safe(self.home_position[0], self.home_position[1], self.home_position[2])
                self.set_suction(False)
                return False
        else:
            print("âŒ æ‹¾å–å¤±è´¥")
            return False
    
    def test_suction(self):
        """æµ‹è¯•å¸ç›˜åŠŸèƒ½"""
        print("\nğŸ§ª å¼€å§‹å¸ç›˜æµ‹è¯•...")
        
        # æµ‹è¯•å¼€å¯å¸ç›˜
        print("1. æµ‹è¯•å¼€å¯å¸ç›˜...")
        if self.set_suction(True):
            print("âœ… å¸ç›˜å¼€å¯æµ‹è¯•æˆåŠŸ")
        else:
            print("âŒ å¸ç›˜å¼€å¯æµ‹è¯•å¤±è´¥")
            return False
        
        time.sleep(2)
        
        # æµ‹è¯•å…³é—­å¸ç›˜
        print("2. æµ‹è¯•å…³é—­å¸ç›˜...")
        if self.set_suction(False):
            print("âœ… å¸ç›˜å…³é—­æµ‹è¯•æˆåŠŸ")
        else:
            print("âŒ å¸ç›˜å…³é—­æµ‹è¯•å¤±è´¥")
            return False
        
        print("ğŸ‰ å¸ç›˜æµ‹è¯•å…¨éƒ¨å®Œæˆï¼")
        return True
    
    def calibration_routine(self):
        """æ ¡å‡†ç¨‹åº"""
        print("\nğŸ¯ å¼€å§‹æ ¡å‡†ç¨‹åº...")
        print("è¯·ç¡®ä¿:")
        print("1. æœºæ¢°è‡‚å·¥ä½œåŒºåŸŸå†…æ²¡æœ‰éšœç¢ç‰©")
        print("2. å¸ç›˜æ¸…æ´æ— å µå¡")
        print("3. æ°”æºè¿æ¥æ­£å¸¸")
        
        input("æŒ‰å›è½¦é”®å¼€å§‹æ ¡å‡†...")
        
        # ç§»åŠ¨åˆ°å®‰å…¨ä½ç½®
        self.move_to_safe(*self.home_position)
        
        # æµ‹è¯•å¸ç›˜
        if not self.test_suction():
            return False
        
        # æµ‹è¯•æ‹¾å–æ”¾ç½®å¾ªç¯
        print("\n3. æµ‹è¯•æ‹¾å–æ”¾ç½®å¾ªç¯...")
        success = self.pick_and_place(
            pick_x=250, pick_y=0, 
            place_x=150, place_y=150,
            pick_z=0, place_z=0,
            object_height=10
        )
        
        if success:
            print("âœ… æ ¡å‡†å®Œæˆï¼ç³»ç»Ÿå‡†å¤‡å°±ç»ª")
        else:
            print("âŒ æ ¡å‡†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿ")
        
        return success
    
    def auto_pick_place_demo(self, num_cycles=3):
        """è‡ªåŠ¨æ‹¾å–æ”¾ç½®æ¼”ç¤º"""
        print(f"\nğŸ¤– å¼€å§‹è‡ªåŠ¨æ‹¾å–æ”¾ç½®æ¼”ç¤º ({num_cycles} æ¬¡å¾ªç¯)")
        
        for i in range(num_cycles):
            print(f"\n--- ç¬¬ {i+1} æ¬¡å¾ªç¯ ---")
            
            # åœ¨ä¸åŒä½ç½®é—´ç§»åŠ¨ç‰©ä½“
            positions = [
                ((250, 0), (150, 150)),   # ä½ç½®1åˆ°ä½ç½®2
                ((150, 150), (150, -150)), # ä½ç½®2åˆ°ä½ç½®3
                ((150, -150), (250, 0))    # ä½ç½®3å›åˆ°ä½ç½®1
            ]
            
            for (pick_pos, place_pos) in positions:
                success = self.pick_and_place(
                    pick_x=pick_pos[0], pick_y=pick_pos[1],
                    place_x=place_pos[0], place_y=place_pos[1],
                    pick_z=0, place_z=0,
                    object_height=10
                )
                
                if not success:
                    print("âŒ æ¼”ç¤ºä¸­æ–­")
                    return False
                
                time.sleep(1)
        
        print("ğŸ‰ è‡ªåŠ¨æ¼”ç¤ºå®Œæˆï¼")
        return True
    
    def get_status(self):
        """è·å–ç³»ç»ŸçŠ¶æ€"""
        if not self.is_connected:
            return "âŒ æœªè¿æ¥"
        
        pose = self.dobot.pose()
        suction_status = "ğŸ”´ å·¥ä½œä¸­" if self.suction_enabled else "âšª å…³é—­"
        
        status = f"""
ğŸ¤– æœºæ¢°è‡‚çŠ¶æ€:
ğŸ“ ä½ç½®: X={pose[0]:.1f}, Y={pose[1]:.1f}, Z={pose[2]:.1f}
ğŸ”„ å¸ç›˜: {suction_status}
ğŸ”— è¿æ¥: âœ… å·²è¿æ¥
        """
        return status
    
    def disconnect(self):
        """æ–­å¼€è¿æ¥"""
        if self.dobot:
            # ç¡®ä¿å¸ç›˜å…³é—­
            self.set_suction(False)
            # å›åˆ°å®‰å…¨ä½ç½®
            self.move_to_safe(*self.home_position)
            self.dobot.close()
            print("ğŸ”Œ å·²æ–­å¼€è¿æ¥")


def main():
    """ä¸»ç¨‹åº"""
    print("=" * 60)
    print("            Dobot Magician å¸ç›˜æ§åˆ¶ç³»ç»Ÿ")
    print("=" * 60)
    
    # åˆå§‹åŒ–æœºæ¢°è‡‚
    arm = SuctionArm(port='/dev/ttyUSB0', verbose=True)
    
    if not arm.is_connected:
        print("æ— æ³•å¯åŠ¨ç³»ç»Ÿï¼Œè¯·æ£€æŸ¥è¿æ¥")
        return
    
    try:
        while True:
            print("\n" + "=" * 40)
            print("è¯·é€‰æ‹©æ“ä½œ:")
            print("1. ğŸ§ª å¸ç›˜æµ‹è¯•")
            print("2. ğŸ¯ æ ¡å‡†ç¨‹åº")
            print("3. ğŸ¤– è‡ªåŠ¨æ¼”ç¤º")
            print("4. ğŸ¯ å•æ¬¡æ‹¾å–æ”¾ç½®")
            print("5. ğŸ“Š ç³»ç»ŸçŠ¶æ€")
            print("6. âŒ é€€å‡º")
            print("=" * 40)
            
            choice = input("è¯·è¾“å…¥é€‰æ‹© (1-6): ").strip()
            
            if choice == '1':
                arm.test_suction()
                
            elif choice == '2':
                arm.calibration_routine()
                
            elif choice == '3':
                cycles = input("è¯·è¾“å…¥å¾ªç¯æ¬¡æ•° (é»˜è®¤ 3): ").strip()
                try:
                    cycles = int(cycles) if cycles else 3
                    arm.auto_pick_place_demo(cycles)
                except ValueError:
                    print("âŒ è¾“å…¥æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼ 3")
                    arm.auto_pick_place_demo()
                    
            elif choice == '4':
                try:
                    pick_x = float(input("æ‹¾å–ä½ç½® X (é»˜è®¤ 250): ") or 250)
                    pick_y = float(input("æ‹¾å–ä½ç½® Y (é»˜è®¤ 0): ") or 0)
                    place_x = float(input("æ”¾ç½®ä½ç½® X (é»˜è®¤ 150): ") or 150)
                    place_y = float(input("æ”¾ç½®ä½ç½® Y (é»˜è®¤ 150): ") or 150)
                    
                    arm.pick_and_place(pick_x, pick_y, place_x, place_y)
                except ValueError:
                    print("âŒ è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥æ•°å­—")
                    
            elif choice == '5':
                print(arm.get_status())
                
            elif choice == '6':
                print("è°¢è°¢ä½¿ç”¨ï¼")
                break
                
            else:
                print("âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥")
                
            input("\næŒ‰å›è½¦é”®ç»§ç»­...")
            
    except KeyboardInterrupt:
        print("\n\nâ¹ï¸ ç”¨æˆ·ä¸­æ–­ç¨‹åº")
    except Exception as e:
        print(f"\nâŒ ç¨‹åºé”™è¯¯: {e}")
    finally:
        arm.disconnect()


if __name__ == "__main__":
    main()
